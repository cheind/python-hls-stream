<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>HLS Streaming Demo</title>
    <link href="https://vjs.zencdn.net/7.18.1/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.18.1/video.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .video-parent {
            width: 40%;
            margin: 0px auto;
        }

        .vjs-marker {
            position: absolute;
            background: red;
            width: 5px;
            height: 110%;
            top: -5%;
            z-index: 30;
            margin-left: -3px;
        }

        .vjs-marker:hover span {
            opacity: 1;
        }

        .vjs-marker span {
            position: absolute;
            bottom: 15px;
            opacity: 0;
            margin-left: -20px;
            z-index: 90;
            background: rgba(0, 0, 0, .8);
            padding: 8px;
            font-size: 10px;
        }
    </style>
</head>

<body>
    <div class="video-parent">
        <video id="my-video" class="video-js vjs-fluid vjs-fill" controls autoplay muted preload="auto"
            data-setup='{"liveui": true}'>
            <source src="//127.0.0.1:5000/video/chessboard.m3u8" type="application/x-mpegURL">
            <!--<track kind="chapters" src="//127.0.0.1:5000/video/chessboard.vtt" srclang="en" label="English" default>-->
        </video>
        <ul id="markers"></ul>
    </div>
</body>
<script>


    var markers = [];
    var video = null;
    var vhs = null;

    var update_markers = function () {
        const vhs = video.tech().vhs;
        const segments = vhs.playlists.media().segments;
        const lastSegment = segments[segments.length - 1];
        const firstSegment = segments[0];

        console.log(segments);

        var live = video.liveTracker.liveCurrentTime();
        console.log('live ', live)
        let low_dt = Date.parse(firstSegment.dateTimeString);
        let high_dt = Date.parse(lastSegment.dateTimeString) + lastSegment.duration * 1000;
        console.log((high_dt - low_dt) / 1e3, low_dt, high_dt)

        if (!firstSegment || !firstSegment.videoTimingInfo ||
            !lastSegment || !lastSegment.videoTimingInfo) {
            return;
        }

        // Instead we should query the backend api?



        var low = firstSegment.videoTimingInfo.baseMediaDecodeTime;
        var high = lastSegment.videoTimingInfo.baseMediaDecodeTime;


        console.log("absolute time is :", high, " first time is ", low);


        var pbar = jQuery(video.controlBar.progressControl.children_[0].el_);
        for (var i = 0; i < markers.length; i++) {

            var left = (markers[i].time - low) / (high - low);
            console.log("left ", i, " ", left)
            visible = left >= 0 && left <= 1.0;
            left = Math.min(Math.max(left, 0.0), 1.0);

            if ("el" in markers[i]) {
                // update
                el = markers[i].el;
                el.css({ 'left': left * 100 + '%' });
            } else {
                var time = markers[i].time;
                var el = jQuery('<div class="vjs-marker" style="left:' + left * 100 + "%" + '" data-time="' + time + '"><span>' + markers[i].label + '</span></div>');
                el.click(function () {
                    video.currentTime($(this).data('time'));
                });
                pbar.append(el);
                markers[i]['el'] = el;
            }

            el.css('visibility', visible ? 'visible' : 'hidden');
        }
    }

    function endpoints(media) {
        const segments = media.segments;
        const last = segments[segments.length - 1];
        const first = segments[0];

        const duration = media.targetDuration;
        const seq = media.mediaSequence;
        const lt = video.liveTracker

        const low = duration * seq;
        //const high = lt.seekableEnd() - lt.seekableStart() + low;
        const high = segments.reduce(function (prev, seg) {
            return prev + seg.duration;
        }, low);

        console.log('low', low, 'high', high);
        return {
            'low': low,
            'high': high
        };
    }

    function move_markers_inner() {
        if (!vhs) {
            vhs = video.tech().vhs;
        } else {
            const media = vhs.playlists.media();
            if (!media) {
                return;
            }
            const ep = endpoints(media);
            var pbar = jQuery(video.controlBar.progressControl.children_[0].el_);

            for (var i = 0; i < markers.length; i++) {
                var left = (markers[i].time - ep.low) / (ep.high - ep.low);
                visible = left >= 0 && left <= 1.0;
                left = Math.min(Math.max(left, 0.0), 1.0);

                if ("el" in markers[i]) {
                    // update
                    el = markers[i].el;
                    el.css({ 'left': left * 100 + '%' });
                } else {
                    var el = jQuery('<div class="vjs-marker" style="left:' + left * 100 + "%" + '" data-time="' + markers[i].time + '"><span>' + markers[i].text + '</span></div>');
                    el.click(function () {
                        video.currentTime($(this).data('time'));
                    });
                    pbar.append(el);
                    markers[i]['el'] = el;
                }
                el.css('visibility', visible ? 'visible' : 'hidden');
            }
        }
    }

    function move_markers() {
        move_markers_inner();
        requestAnimationFrame(move_markers);
    }


    var update_markers = function () {
        data = { 'ts_start': -1.0 }
        if (markers.length > 0) {
            data['ts_start'] = markers[markers.length - 1]['time']
        }
        return $.ajax({
            'type': 'get',
            'url': '//127.0.0.1:5000/markers',
            'data': data
        }).then(function (results) {
            results = JSON.parse(results);
            new_markers = results['markers']
            new_markers.forEach(function (m) {
                $("#markers").append("<li>" + m['time'].toFixed(1) + ' ' + m['text'] + "</li>");
            });
            markers = markers.concat(new_markers)
        });
    }



    $(document).ready(function () {
        video = videojs('my-video');
        video.play();
        update_markers();
        move_markers();
    });
    var intervalId2 = setInterval(update_markers, 5000);





    // var intervalId = setInterval(function () {
    //     document.getElementById("current_time").innerHTML = video.liveTracker.liveCurrentTime();
    // }, 5000);


</script>

</html>